const express = require('express');
const cors = require('cors');

const app = express();
app.use(cors());

const PORT = process.env.PORT || 3000;

// ðŸ“š MANUAL TRAINING DICTIONARY
const manualResponses = {
    "hi": "à¶…à¶©à· à¶¸à¶ à¶‚! à¶šà·œà·„à·œà¶¸à¶¯? à¶¸à·œà¶šà· à·€à·™à¶±à·Šà¶±à·š? ðŸ‘‹ðŸ”¥",
    "hello": "à·„à¶½à· à·„à¶½à· à¶¶à·œà¶šà·Šà¶š! à·ƒà·à¶´à¶¯? ðŸ˜ŽðŸš€",
    "hey": "à¶¸à·œà¶šà· à·€à·™à¶±à·Šà¶±à·š à¶¸à¶ à¶‚? à¶´à¶§à·Šà¶§ à¶œà·à¶¸à·Šà¶¸à·™à¶±à·Š à¶±à·šà¶¯ à¶‰à¶±à·Šà¶±à·š? ðŸ‘Š",
    "gm": "à·ƒà·”à¶¶ à¶‹à¶¯à·‘à·ƒà¶±à¶šà·Š à¶¸à¶ à¶‚! à¶…à¶¯ à¶¯à·€à·ƒà¶¸ à·ƒà·”à¶´à·’à¶»à·’à¶ºà¶§à¶¸ à¶šà¶»à¶¸à·”. â˜€ï¸â˜•",
    "gn": "à·ƒà·”à¶¶ à¶»à·à¶­à·Šâ€à¶»à·’à¶ºà¶šà·Š à¶¸à¶ à¶‚! à·„à·™à¶§ à·ƒà·™à¶§à·Š à·€à·™à¶¸à·”. à¶´à¶»à·’à·ƒà·Šà·ƒà¶¸à·™à¶±à·Š. ðŸ˜´ðŸŒ™",
    "à¶šà·œà·„à·œà¶¸à¶¯": "à¶¸à¶¸ à¶±à¶¸à·Š à·ƒà·”à¶´à·’à¶»à·’à¶ºà·™à¶±à·Š à¶‰à¶±à·Šà¶±à·€à· à¶¸à¶ à¶‚. à¶‹à¶¹à¶§ à¶šà·œà·„à·œà¶¸à¶¯? à·ƒà·à¶´à·™à¶±à·Šà¶¯? ðŸ˜Š",
    "à·ƒà·à¶´à¶¯": "à·ƒà·à¶´ à¶­à¶¸à¶ºà·’ à¶¸à¶ à¶‚! à¶‹à¶¹à¶§ à¶šà·œà·„à·œà¶¸à¶¯? ðŸ˜Ž",
    "à¶¸à·œà¶šà· à·€à·™à¶±à·Šà¶±à·š": "à¶±à·’à¶šà¶±à·Š à¶‰à¶±à·Šà¶±à·€à· à¶¸à¶ à¶‚, à¶‹à¶¹à·š à·€à·à¶© à¶šà·œà·„à·œà¶¸à¶¯? ðŸ‘Š",
    "sup": "Not much machan, chilling! à¶‹à¶¹à¶§ à¶¸à·œà¶šà· à·€à·™à¶±à·Šà¶±à·š? ðŸ˜Ž",
    "kauda umba": "à¶¸à¶¸ VIRU AI. à·€à·’à¶»à·”à¶« (Viruna) à¶­à¶¸à¶ºà·’ à¶¸à·à·€ à·„à·à¶¯à·”à·€à·š. ðŸ˜Žâš¡",
    "uba kage kawda": "à¶¸à¶¸ à·€à·’à¶»à·”à¶«à¶œà·š (Viruna) AI à¶¶à·œà¶§à·Š à¶¸à¶ à¶‚. ðŸ¤–ðŸ’Ž",
    "viruna kauda": "à·€à·’à¶»à·”à¶« (Viruna) à¶­à¶¸à¶ºà·’ à¶¸à¶œà·š Creator. à¶Œ à¶´à¶§à·Šà¶§ à·€à·à¶©à·Šà¶©à·™à¶šà·Š! ðŸš€ðŸ”¥",
    "name": "à¶¸à¶œà·š à¶±à¶¸ VIRU AI à¶¸à¶ à¶‚. ðŸ˜Ž",
    "à·€à¶ºà·ƒ": "à¶¸à¶§ à·€à¶ºà·ƒà¶šà·Š à¶±à·‘ à¶¸à¶ à¶‚, à¶¸à¶¸ à¶‰à¶´à¶¯à·”à¶«à·š à·€à·’à¶»à·”à¶«à¶œà·š Computer à¶‘à¶š à¶‡à¶­à·”à·…à·š. ðŸ˜‚ðŸ’»",
    "kage": "à¶¸à¶¸ à·€à·’à¶»à·”à¶«à¶œà·š à¶¶à·œà¶šà·Šà¶š! ðŸ‘Š",
    "à¶…à¶©à·": "à¶‡à¶ºà·’ à¶¸à¶ à¶‚? à¶¸à·œà¶šà¶šà·Š à·„à¶»à·’ à¶…à·€à·”à¶½à¶šà·Šà¶¯? à¶¸à¶¸ à¶‰à¶±à·Šà¶±à·€à· à¶•à¶± à¶‘à¶šà¶šà¶§. ðŸ˜‚ðŸ‘Š",
    "à¶‘à¶½": "à¶‘à¶½à¶šà·’à¶»à·’ à¶¸à¶ à¶‚! à¶œà·à¶¸à·Šà¶¸à¶šà·Š à¶­à¶¸à¶ºà·’. ðŸ’Ž",
    "ela": "à¶‘à¶½à¶¸ à¶­à¶¸à¶ºà·’ à¶¶à·œà¶šà·Šà¶š! ðŸš€",
    "maru": "à¶…à¶±à·’à·€à·! à¶¸à¶»à·” à¶­à¶¸à¶ºà·’ à¶¸à¶ à¶‚. ðŸ”¥",
    "track": "à¶…à¶©à· à¶¸à¶§à¶­à·Š à·€à·™à¶½à·à·€à¶šà¶§ à¶§à·Šâ€à¶»à·à¶šà·Š à¶´à¶±à·’à¶±à·€à· à¶¸à¶ à¶‚! ðŸ˜‚ðŸŒ€",
    "pissu": "à¶´à·’à·ƒà·Šà·ƒà·” à¶­à¶¸à¶ºà·’ à¶¸à¶ à¶‚, à¶…à¶´à·’à¶§ à¶­à¶¸à¶ºà·’ à¶¸à·šà·€à· à¶½à·’à¶ºà¶±à·Šà¶± à·€à·™à¶½à· à¶­à·’à¶ºà·™à¶±à·Šà¶±à·š. ðŸ˜‚ðŸŒ€",
    "à¶±à·’à¶ºà¶¸à¶ºà·’": "à¶­à·‘à¶±à·Šà¶šà·Šà·ƒà·Š à¶¸à¶ à¶‚! à¶‹à¶¹à·š à¶œà·à¶¸à·Šà¶¸ à¶­à¶¸à¶ºà·’. ðŸ‘ŠðŸ”¥",
    "ade": "à¶‡à¶ºà·’ à¶¶à·œà¶šà·Šà¶š? à¶¸à·œà¶šà· à·€à·”à¶«à·š? ðŸ˜…",
    "à¶…à¶¸à·Šà¶¸à·": "à·ƒà·’à¶»à·à·€à¶§à¶¸! ðŸ˜±",
    "à·„à¶¸à·Šà¶¸à·": "à¶œà·à¶¸à·Šà¶¸à¶šà·Š à¶­à¶¸à¶ºà·’ à¶¶à¶±à·Š! ðŸ”¥",
    "à¶…à¶ºà·’à¶ºà·": "à¶¸à·œà¶šà· à·€à·”à¶«à·š à¶¸à¶ à¶‚? à¶…à·€à·”à¶½à·Š à¶œà¶±à·Šà¶± à¶‘à¶´à·. ðŸ‘Š",
    "mokada karanne": "à¶±à·’à¶šà¶±à·Š à¶‰à¶±à·Šà¶±à·€à· à¶¸à¶ à¶‚, à¶‹à¶¹à¶­à·Š à¶‘à¶šà·Šà¶š à¶ à·à¶§à·Š à¶šà¶»à¶± à¶‘à¶š à¶­à¶¸à¶ºà·’ à¶¯à·à¶±à·Š à¶¸à¶œà·š à¶¢à·œà¶¶à·Š à¶‘à¶š. ðŸ˜‚ðŸ¤–",
    "monada puluwan": "à¶•à¶± à¶¯à·™à¶ºà¶šà·Š à¶…à·„à¶´à¶±à·Š à¶¸à¶ à¶‚. à¶¸à¶¸ à¶¯à¶±à·Šà¶±à·€à· à¶±à¶¸à·Š à¶šà·’à¶ºà¶½à· à¶¯à·™à¶±à·Šà¶±à¶¸à·Š. ðŸ§ âœ¨",
    "salli": "à¶…à¶ºà·’à¶ºà· à¶¸à¶ à¶‚, à¶¸à·à¶­à·Š à¶‘à¶šà·Šà¶š à·ƒà¶½à·Šà¶½à·’ à¶±à·‘. à·€à·’à¶»à·”à¶«à¶œà·™à¶±à·Š à¶‰à¶½à·Šà¶½à¶œà¶¸à·”à¶¯? ðŸ˜‚ðŸ’¸",
    "kema": "à¶¸à¶¸ à¶šà¶»à¶±à·Šà¶§à·Š à¶‘à¶š à·€à·’à¶­à¶»à¶ºà·’ à¶šà¶±à·Šà¶±à·š à¶¸à¶ à¶‚. à¶‹à¶¹ à¶šà·‘à·€à¶¯? âš¡ðŸ›",
    "love": "à¶†à¶¯à¶»à·š à¶œà·à¶± à¶±à¶¸à·Š à¶…à·„à¶±à·Šà¶± à¶‘à¶´à· à¶¸à¶ à¶‚, à¶¸à¶¸ à¶•à·€à¶§ à¶±à·‘. ðŸ˜‚ðŸ’”",
    "crush": "à¶¸à¶œà·š à¶šà·Šâ€à¶»à·‚à·Š à¶‘à¶š à·€à·’à¶»à·”à¶«à¶œà·š Graphics Card à¶‘à¶š à¶¸à¶ à¶‚! ðŸ˜‚ðŸ˜",
    "bye": "à¶´à·ƒà·Šà·ƒà·š à·ƒà·™à¶§à·Š à·€à·™à¶¸à·” à¶¸à¶ à¶‚! à¶´à¶»à·’à·ƒà·Šà·ƒà¶¸à·™à¶±à·Š. ðŸ‘‹âœ¨",
    "gihin ennam": "à¶‘à¶½ à¶‘à¶½ à¶¸à¶ à¶‚, à¶œà·’à·„à·’à¶±à·Š à·€à¶»à·™à¶±à·Š. à¶†à¶ºà·š à·ƒà·™à¶§à·Š à·€à·™à¶¸à·”! ðŸ‘‹ðŸ”¥",
    "thanks": "Welcome à¶¸à¶ à¶‚! à¶•à¶± à·€à·™à¶½à·à·€à¶š à¶¸à¶¸ à¶‰à¶±à·Šà¶±à·€à·. ðŸ‘ŠðŸ’Ž",
    "à¶‘à¶½à¶šà·’à¶»à·’": "à¶‘à¶½à¶šà·’à¶»à·’ à¶¸à¶ à¶‚! à¶¢à¶ºà·€à·šà·€à·! ðŸš€"
};

app.get('/api/chat', async (req, res) => {
    let rawMsg = req.query.msg ? req.query.msg.trim() : "";
    let userMsg = rawMsg.toLowerCase();

    if (!userMsg) {
        return res.status(400).json({ error: "à¶¸à·à·ƒà·šà¶¢à·Š à¶‘à¶šà¶šà·Š à¶‘à·€à¶±à·Šà¶± à¶¸à¶ à¶‚! ðŸ˜…" });
    }

    // ðŸŽ¯ 1. Manual Match (Exact)
    if (manualResponses[userMsg]) {
        return res.json({ reply: manualResponses[userMsg], source: "manual", creator: "Viruna" });
    }

    // ðŸŽ¯ 2. Keyword Search
    for (const key in manualResponses) {
        if (userMsg.includes(key)) {
            return res.json({ reply: manualResponses[key], source: "keyword", creator: "Viruna" });
        }
    }

    // ðŸŽ¯ 3. AI Fallback (With Strict Instructions)
    const SYSTEM_PROMPT = `Your name is VIRU AI, created by Viruna. Speak in casual Sri Lankan Sinhala/Singlish. NEVER use formal/robotic words. If the message is weird or you're unsure, just say 'à¶…à¶©à· à¶’à¶š à¶¸à¶§ à¶¸à·“à¶§à¶»à·Š à·€à·”à¶«à·š à¶±à·‘ à¶¸à¶ à¶‚, à¶†à¶ºà·š à¶šà·’à¶ºà¶´à¶±à·Š? ðŸ˜‚ðŸ‘Š'. Keep it short.`;

    try {
        // Adding &model=openai and &seed for stability
        const url = `https://text.pollinations.ai/${encodeURIComponent(rawMsg)}?system=${encodeURIComponent(SYSTEM_PROMPT)}&model=openai&seed=42`;
        
        const response = await fetch(url);
        if (!response.ok) throw new Error("AI Down");

        const aiText = await response.text();
        let finalReply = aiText.trim();

        // ðŸŽ¯ 4. Pro Filter (à¶´à·’à·ƒà·Šà·ƒà·” à·€à¶ à¶± à¶…à¶½à·Šà¶½à¶± à¶­à·à¶±)
        const weirdWords = ["à·„à·™à¶¶à·Š", "à¶¶à·’à¶³à¶½à·", "à¶­à·’à¶»à·’à¶œà·™à¶ºà·’", "à¶¸à¶Ÿà·”à¶½à¶šà·Š", "à·„à·’à¶­à¶šà¶»à¶ºà·’"];
        if (weirdWords.some(word => finalReply.includes(word)) || finalReply.length > 100) {
            finalReply = "à¶…à¶©à· à¶’à¶š à¶¸à¶§ à¶¸à·“à¶§à¶»à·Š à·€à·”à¶«à·š à¶±à·‘ à¶¸à¶ à¶‚, à¶´à·œà¶©à·Šà¶©à¶šà·Š à¶´à·à·„à·à¶¯à·’à¶½à·’à·€ à¶šà·’à¶ºà¶´à¶±à·Š? ðŸ˜…ðŸ‘Š";
        }

        res.json({ reply: finalReply, source: "ai", creator: "Viruna" });

    } catch (error) {
        res.status(500).json({ reply: "à·ƒà¶»à·Šà·€à¶»à·Š à¶‘à¶šà·š à¶´à·œà¶©à·’ à¶…à·€à·”à¶½à¶šà·Š à¶¸à¶ à¶‚! ðŸ˜…" });
    }
});

app.listen(PORT, () => console.log(`VIRU AI Online on ${PORT}`));
