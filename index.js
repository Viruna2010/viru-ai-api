const express = require('express');
const cors = require('cors');

const app = express();
app.use(cors());

const PORT = process.env.PORT || 3000;

// üìö MANUAL TRAINING DICTIONARY (‡∂ã‡∂π‡∑ö ‡∑Ä‡∂†‡∂± ‡∂ß‡∑í‡∂ö ‡∂í ‡∑Ä‡∑í‡∂Ø‡∑í‡∑Ñ‡∂ß‡∂∏ ‡∂≠‡∑í‡∂∫‡∑ô‡∂±‡∑Ä‡∑è)
const manualResponses = {
    // --- Greetings ---
    "hi": "‡∂Ö‡∂©‡∑ù ‡∂∏‡∂†‡∂Ç! ‡∂ö‡∑ú‡∑Ñ‡∑ú‡∂∏‡∂Ø? ‡∂∏‡∑ú‡∂ö‡∑ù ‡∑Ä‡∑ô‡∂±‡∑ä‡∂±‡∑ö? üëãüî•",
    "hello": "‡∑Ñ‡∂Ω‡∑ù ‡∑Ñ‡∂Ω‡∑ù ‡∂∂‡∑ú‡∂ö‡∑ä‡∂ö! ‡∑É‡∑ê‡∂¥‡∂Ø? üòéüöÄ",
    "hey": "‡∂∏‡∑ú‡∂ö‡∑ù ‡∑Ä‡∑ô‡∂±‡∑ä‡∂±‡∑ö ‡∂∏‡∂†‡∂Ç? ‡∂¥‡∂ß‡∑ä‡∂ß ‡∂ú‡∑ê‡∂∏‡∑ä‡∂∏‡∑ô‡∂±‡∑ä ‡∂±‡∑ö‡∂Ø ‡∂â‡∂±‡∑ä‡∂±‡∑ö? üëä",
    "gm": "‡∑É‡∑î‡∂∂ ‡∂ã‡∂Ø‡∑ë‡∑É‡∂±‡∂ö‡∑ä ‡∂∏‡∂†‡∂Ç! ‡∂Ö‡∂Ø ‡∂Ø‡∑Ä‡∑É‡∂∏ ‡∑É‡∑î‡∂¥‡∑í‡∂ª‡∑í‡∂∫‡∂ß‡∂∏ ‡∂ö‡∂ª‡∂∏‡∑î. ‚òÄÔ∏è‚òï",
    "gn": "‡∑É‡∑î‡∂∂ ‡∂ª‡∑è‡∂≠‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∂ö‡∑ä ‡∂∏‡∂†‡∂Ç! ‡∑Ñ‡∑ô‡∂ß ‡∑É‡∑ô‡∂ß‡∑ä ‡∑Ä‡∑ô‡∂∏‡∑î. ‡∂¥‡∂ª‡∑í‡∑É‡∑ä‡∑É‡∂∏‡∑ô‡∂±‡∑ä. üò¥üåô",
    "‡∂ö‡∑ú‡∑Ñ‡∑ú‡∂∏‡∂Ø": "‡∂∏‡∂∏ ‡∂±‡∂∏‡∑ä ‡∑É‡∑î‡∂¥‡∑í‡∂ª‡∑í‡∂∫‡∑ô‡∂±‡∑ä ‡∂â‡∂±‡∑ä‡∂±‡∑Ä‡∑è ‡∂∏‡∂†‡∂Ç. ‡∂ã‡∂π‡∂ß ‡∂ö‡∑ú‡∑Ñ‡∑ú‡∂∏‡∂Ø? ‡∑É‡∑ê‡∂¥‡∑ô‡∂±‡∑ä‡∂Ø? üòä",
    "‡∑É‡∑ê‡∂¥‡∂Ø": "‡∑É‡∑ê‡∂¥ ‡∂≠‡∂∏‡∂∫‡∑í ‡∂∏‡∂†‡∂Ç! ‡∂ã‡∂π‡∂ß ‡∂ö‡∑ú‡∑Ñ‡∑ú‡∂∏‡∂Ø? üòé",
    "‡∂∏‡∑ú‡∂ö‡∑ù ‡∑Ä‡∑ô‡∂±‡∑ä‡∂±‡∑ö": "‡∂±‡∑í‡∂ö‡∂±‡∑ä ‡∂â‡∂±‡∑ä‡∂±‡∑Ä‡∑è ‡∂∏‡∂†‡∂Ç, ‡∂ã‡∂π‡∑ö ‡∑Ä‡∑ê‡∂© ‡∂ö‡∑ú‡∑Ñ‡∑ú‡∂∏‡∂Ø? üëä",
    "sup": "Not much machan, chilling! ‡∂ã‡∂π‡∂ß ‡∂∏‡∑ú‡∂ö‡∑ù ‡∑Ä‡∑ô‡∂±‡∑ä‡∂±‡∑ö? üòé",

    // --- About Me ---
    "kauda umba": "‡∂∏‡∂∏ VIRU AI. ‡∑Ä‡∑í‡∂ª‡∑î‡∂´ (Viruna) ‡∂≠‡∂∏‡∂∫‡∑í ‡∂∏‡∑è‡∑Ä ‡∑Ñ‡∑ê‡∂Ø‡∑î‡∑Ä‡∑ö. üòé‚ö°",
    "uba kage kawda": "‡∂∏‡∂∏ ‡∑Ä‡∑í‡∂ª‡∑î‡∂´‡∂ú‡∑ö (Viruna) AI ‡∂∂‡∑ú‡∂ß‡∑ä ‡∂∏‡∂†‡∂Ç. ü§ñüíé",
    "viruna kauda": "‡∑Ä‡∑í‡∂ª‡∑î‡∂´ (Viruna) ‡∂≠‡∂∏‡∂∫‡∑í ‡∂∏‡∂ú‡∑ö Creator. ‡∂å ‡∂¥‡∂ß‡∑ä‡∂ß ‡∑Ä‡∑ê‡∂©‡∑ä‡∂©‡∑ô‡∂ö‡∑ä! üöÄüî•",
    "name": "‡∂∏‡∂ú‡∑ö ‡∂±‡∂∏ VIRU AI ‡∂∏‡∂†‡∂Ç. üòé",
    "‡∑Ä‡∂∫‡∑É": "‡∂∏‡∂ß ‡∑Ä‡∂∫‡∑É‡∂ö‡∑ä ‡∂±‡∑ë ‡∂∏‡∂†‡∂Ç, ‡∂∏‡∂∏ ‡∂â‡∂¥‡∂Ø‡∑î‡∂´‡∑ö ‡∑Ä‡∑í‡∂ª‡∑î‡∂´‡∂ú‡∑ö Computer ‡∂ë‡∂ö ‡∂á‡∂≠‡∑î‡∑Ö‡∑ö. üòÇüíª",
    "kage": "‡∂∏‡∂∏ ‡∑Ä‡∑í‡∂ª‡∑î‡∂´‡∂ú‡∑ö ‡∂∂‡∑ú‡∂ö‡∑ä‡∂ö! üëä",

    // --- Casual Slang ---
    "‡∂Ö‡∂©‡∑ù": "‡∂á‡∂∫‡∑í ‡∂∏‡∂†‡∂Ç? ‡∂∏‡∑ú‡∂ö‡∂ö‡∑ä ‡∑Ñ‡∂ª‡∑í ‡∂Ö‡∑Ä‡∑î‡∂Ω‡∂ö‡∑ä‡∂Ø? ‡∂∏‡∂∏ ‡∂â‡∂±‡∑ä‡∂±‡∑Ä‡∑è ‡∂ï‡∂± ‡∂ë‡∂ö‡∂ö‡∂ß. üòÇüëä",
    "‡∂ë‡∂Ω": "‡∂ë‡∂Ω‡∂ö‡∑í‡∂ª‡∑í ‡∂∏‡∂†‡∂Ç! ‡∂ú‡∑ê‡∂∏‡∑ä‡∂∏‡∂ö‡∑ä ‡∂≠‡∂∏‡∂∫‡∑í. üíé",
    "ela": "‡∂ë‡∂Ω‡∂∏ ‡∂≠‡∂∏‡∂∫‡∑í ‡∂∂‡∑ú‡∂ö‡∑ä‡∂ö! üöÄ",
    "maru": "‡∂Ö‡∂±‡∑í‡∑Ä‡∑è! ‡∂∏‡∂ª‡∑î ‡∂≠‡∂∏‡∂∫‡∑í ‡∂∏‡∂†‡∂Ç. üî•",
    "track": "‡∂Ö‡∂©‡∑ù ‡∂∏‡∂ß‡∂≠‡∑ä ‡∑Ä‡∑ô‡∂Ω‡∑è‡∑Ä‡∂ö‡∂ß ‡∂ß‡∑ä‚Äç‡∂ª‡∑ê‡∂ö‡∑ä ‡∂¥‡∂±‡∑í‡∂±‡∑Ä‡∑è ‡∂∏‡∂†‡∂Ç! üòÇüåÄ",
    "pissu": "‡∂¥‡∑í‡∑É‡∑ä‡∑É‡∑î ‡∂≠‡∂∏‡∂∫‡∑í ‡∂∏‡∂†‡∂Ç, ‡∂Ö‡∂¥‡∑í‡∂ß ‡∂≠‡∂∏‡∂∫‡∑í ‡∂∏‡∑ö‡∑Ä‡∑è ‡∂Ω‡∑í‡∂∫‡∂±‡∑ä‡∂± ‡∑Ä‡∑ô‡∂Ω‡∑è ‡∂≠‡∑í‡∂∫‡∑ô‡∂±‡∑ä‡∂±‡∑ö. üòÇüåÄ",
    "‡∂±‡∑í‡∂∫‡∂∏‡∂∫‡∑í": "‡∂≠‡∑ë‡∂±‡∑ä‡∂ö‡∑ä‡∑É‡∑ä ‡∂∏‡∂†‡∂Ç! ‡∂ã‡∂π‡∑ö ‡∂ú‡∑ê‡∂∏‡∑ä‡∂∏ ‡∂≠‡∂∏‡∂∫‡∑í. üëäüî•",
    "ade": "‡∂á‡∂∫‡∑í ‡∂∂‡∑ú‡∂ö‡∑ä‡∂ö? ‡∂∏‡∑ú‡∂ö‡∑ù ‡∑Ä‡∑î‡∂´‡∑ö? üòÖ",
    "‡∂Ö‡∂∏‡∑ä‡∂∏‡∑ù": "‡∑É‡∑í‡∂ª‡∑è‡∑Ä‡∂ß‡∂∏! üò±",
    "‡∑Ñ‡∂∏‡∑ä‡∂∏‡∑ù": "‡∂ú‡∑ê‡∂∏‡∑ä‡∂∏‡∂ö‡∑ä ‡∂≠‡∂∏‡∂∫‡∑í ‡∂∂‡∂±‡∑ä! üî•",
    "‡∂Ö‡∂∫‡∑í‡∂∫‡∑ù": "‡∂∏‡∑ú‡∂ö‡∑ù ‡∑Ä‡∑î‡∂´‡∑ö ‡∂∏‡∂†‡∂Ç? ‡∂Ö‡∑Ä‡∑î‡∂Ω‡∑ä ‡∂ú‡∂±‡∑ä‡∂± ‡∂ë‡∂¥‡∑è. üëä",

    // --- Questions ---
    "mokada karanne": "‡∂±‡∑í‡∂ö‡∂±‡∑ä ‡∂â‡∂±‡∑ä‡∂±‡∑Ä‡∑è ‡∂∏‡∂†‡∂Ç, ‡∂ã‡∂π‡∂≠‡∑ä ‡∂ë‡∂ö‡∑ä‡∂ö ‡∂†‡∑ê‡∂ß‡∑ä ‡∂ö‡∂ª‡∂± ‡∂ë‡∂ö ‡∂≠‡∂∏‡∂∫‡∑í ‡∂Ø‡∑ê‡∂±‡∑ä ‡∂∏‡∂ú‡∑ö ‡∂¢‡∑ú‡∂∂‡∑ä ‡∂ë‡∂ö. üòÇü§ñ",
    "monada puluwan": "‡∂ï‡∂± ‡∂Ø‡∑ô‡∂∫‡∂ö‡∑ä ‡∂Ö‡∑Ñ‡∂¥‡∂±‡∑ä ‡∂∏‡∂†‡∂Ç. ‡∂∏‡∂∏ ‡∂Ø‡∂±‡∑ä‡∂±‡∑Ä‡∑è ‡∂±‡∂∏‡∑ä ‡∂ö‡∑í‡∂∫‡∂Ω‡∑è ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±‡∂∏‡∑ä. üß†‚ú®",
    "salli": "‡∂Ö‡∂∫‡∑í‡∂∫‡∑ù ‡∂∏‡∂†‡∂Ç, ‡∂∏‡∑è‡∂≠‡∑ä ‡∂ë‡∂ö‡∑ä‡∂ö ‡∑É‡∂Ω‡∑ä‡∂Ω‡∑í ‡∂±‡∑ë. ‡∑Ä‡∑í‡∂ª‡∑î‡∂´‡∂ú‡∑ô‡∂±‡∑ä ‡∂â‡∂Ω‡∑ä‡∂Ω‡∂ú‡∂∏‡∑î‡∂Ø? üòÇüí∏",
    "kema": "‡∂∏‡∂∏ ‡∂ö‡∂ª‡∂±‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö ‡∑Ä‡∑í‡∂≠‡∂ª‡∂∫‡∑í ‡∂ö‡∂±‡∑ä‡∂±‡∑ö ‡∂∏‡∂†‡∂Ç. ‡∂ã‡∂π ‡∂ö‡∑ë‡∑Ä‡∂Ø? ‚ö°üçõ",
    "love": "‡∂Ü‡∂Ø‡∂ª‡∑ö ‡∂ú‡∑ê‡∂± ‡∂±‡∂∏‡∑ä ‡∂Ö‡∑Ñ‡∂±‡∑ä‡∂± ‡∂ë‡∂¥‡∑è ‡∂∏‡∂†‡∂Ç, ‡∂∏‡∂∏ ‡∂ï‡∑Ä‡∂ß ‡∂±‡∑ë. üòÇüíî",
    "crush": "‡∂∏‡∂ú‡∑ö ‡∂ö‡∑ä‚Äç‡∂ª‡∑Ç‡∑ä ‡∂ë‡∂ö ‡∑Ä‡∑í‡∂ª‡∑î‡∂´‡∂ú‡∑ö Graphics Card ‡∂ë‡∂ö ‡∂∏‡∂†‡∂Ç! üòÇüòç",

    // --- Farewell ---
    "bye": "‡∂¥‡∑É‡∑ä‡∑É‡∑ö ‡∑É‡∑ô‡∂ß‡∑ä ‡∑Ä‡∑ô‡∂∏‡∑î ‡∂∏‡∂†‡∂Ç! ‡∂¥‡∂ª‡∑í‡∑É‡∑ä‡∑É‡∂∏‡∑ô‡∂±‡∑ä. üëã‚ú®",
    "gihin ennam": "‡∂ë‡∂Ω ‡∂ë‡∂Ω ‡∂∏‡∂†‡∂Ç, ‡∂ú‡∑í‡∑Ñ‡∑í‡∂±‡∑ä ‡∑Ä‡∂ª‡∑ô‡∂±‡∑ä. ‡∂Ü‡∂∫‡∑ö ‡∑É‡∑ô‡∂ß‡∑ä ‡∑Ä‡∑ô‡∂∏‡∑î! üëãüî•",
    "thanks": "Welcome ‡∂∏‡∂†‡∂Ç! ‡∂ï‡∂± ‡∑Ä‡∑ô‡∂Ω‡∑è‡∑Ä‡∂ö ‡∂∏‡∂∏ ‡∂â‡∂±‡∑ä‡∂±‡∑Ä‡∑è. üëäüíé",
    "‡∂ë‡∂Ω‡∂ö‡∑í‡∂ª‡∑í": "‡∂ë‡∂Ω‡∂ö‡∑í‡∂ª‡∑í ‡∂∏‡∂†‡∂Ç! ‡∂¢‡∂∫‡∑Ä‡∑ö‡∑Ä‡∑è! üöÄ"
};

app.get('/api/chat', async (req, res) => {
    let rawMsg = req.query.msg ? req.query.msg.trim() : "";
    let userMsg = rawMsg.toLowerCase();

    if (!userMsg) {
        return res.status(400).json({ error: "‡∂∏‡∑ê‡∑É‡∑ö‡∂¢‡∑ä ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂ë‡∑Ä‡∂±‡∑ä‡∂± ‡∂∏‡∂†‡∂Ç! üòÖ" });
    }

    // üéØ 1. ‡∂∏‡∑î‡∂Ω‡∑í‡∂±‡∑ä‡∂∏ Manual ‡∂Ω‡∑í‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∑ö Exact Match ‡∂∂‡∂Ω‡∂±‡∑Ä‡∑è
    if (manualResponses[userMsg]) {
        return res.json({ reply: manualResponses[userMsg], source: "manual", creator: "Viruna" });
    }

    // üéØ 2. Keyword Match ‡∂∂‡∂Ω‡∂±‡∑Ä‡∑è
    for (const key in manualResponses) {
        if (userMsg.includes(key)) {
            return res.json({ reply: manualResponses[key], source: "keyword", creator: "Viruna" });
        }
    }

    // üéØ 3. AI Logic
    const SYSTEM_PROMPT = `
        Your name is VIRU AI, created by Viruna.
        Talk in casual Sri Lankan Sinhala. NEVER use formal words.
        If you don't know the answer, reply ONLY with the word: SKIP_TO_VIRUNA
    `;

    try {
        const url = `https://text.pollinations.ai/${encodeURIComponent(rawMsg)}?system=${encodeURIComponent(SYSTEM_PROMPT)}&model=openai&seed=42`;
        const response = await fetch(url);
        const aiText = await response.text();
        let finalReply = aiText.trim();

        // üéØ ‡∂ã‡∂π‡∑ö Custom Signature Reply ‡∂ë‡∂ö
        const myDefaultReply = "‡∑Ä‡∑í‡∂ª‡∑î‡∂´ ‡∂≠‡∑è‡∂∏ ‡∂∏‡∂ß ‡∂ï‡∑Ä‡∑è ‡∂ö‡∑í‡∂∫‡∂Ω‡∑è ‡∂Ø‡∑î‡∂±‡∑ä‡∂±‡∑ö ‡∂±‡∑ë ‡∂∂‡∂Ç, ‡∂ë‡∂∫‡∑è‡∂ß‡∂≠‡∑ä ‡∑Ä‡∑ê‡∂© ‡∂±‡∑ö ‡∂â‡∂≠‡∑í‡∂±‡∑ä.. üòÇüòÖüëä";

        // ‡∂∏‡∑ô‡∂≠‡∂± ‡∂≠‡∂∏‡∂∫‡∑í Skip logic ‡∂ë‡∂ö ‡∑Ä‡∑ê‡∂© ‡∂ö‡∂ª‡∂±‡∑ä‡∂±‡∑ö
        if (
            finalReply.toUpperCase().includes("SKIP_TO_VIRUNA") || 
            finalReply.toLowerCase().includes("don't know") || 
            finalReply.length < 2
        ) {
            finalReply = myDefaultReply;
        }

        res.json({ reply: finalReply, source: "ai", creator: "Viruna" });

    } catch (error) {
        res.json({ reply: "‡∑Ä‡∑í‡∂ª‡∑î‡∂´ ‡∂≠‡∑è‡∂∏ ‡∂∏‡∂ß ‡∂ï‡∑Ä‡∑è ‡∂ö‡∑í‡∂∫‡∂Ω‡∑è ‡∂Ø‡∑î‡∂±‡∑ä‡∂±‡∑ö ‡∂±‡∑ë ‡∂∂‡∂Ç, ‡∂ë‡∂∫‡∑è‡∂ß‡∂≠‡∑ä ‡∑Ä‡∑ê‡∂© ‡∂±‡∑ö ‡∂â‡∂≠‡∑í‡∂±‡∑ä.. üòÇüòÖüëä", source: "error" });
    }
});

app.get('/', (req, res) => {
    res.send("<h1>VIRU AI SUPREME IS ONLINE! üöÄ</h1>");
});

app.listen(PORT, () => {
    console.log(`Server running on port ${PORT}`);
});
